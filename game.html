<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spearfisher - SAE 4.02</title>
  <link rel="stylesheet" href="/SAE4.02/src/styles/style.css">

  <!-- Importation d'A-Frame et des extensions n√©cessaires -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="/SAE4.02/src/utils/compatibility-shims.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@4.0.1/dist/aframe-physics-system.min.js"></script>

  <!-- Importation des composants -->
  <script src="/SAE4.02/src/components/water-effect.js"></script>
  <script src="/SAE4.02/src/components/water-adapter.js"></script>
  <script src="/SAE4.02/src/components/grab-manager.js"></script>
  <script src="/SAE4.02/src/components/bubble-spawner.js"></script>
  <script src="/SAE4.02/src/components/fish-rotator.js"></script>
  <script src="/SAE4.02/src/components/realistic-swim.js"></script>

  <script src="/SAE4.02/src/components/fish-spawner.js"></script>
  <script src="/SAE4.02/src/components/room-detection.js"></script>
  <script src="/SAE4.02/src/systems/game-timer.js"></script>
  <script src="/SAE4.02/src/systems/leaderboard-manager.js"></script>
  <script src="/SAE4.02/src/systems/weapon-manager.js"></script>
</head>

<body>
  <!-- Player name input screen (before AR launch) -->
  <div id="player-name-screen">
    <div class="player-name-container">
      <h1>Spearfisher</h1>
      <p>Enter your name to start</p>
      <input type="text" id="player-name-input" placeholder="Your name" maxlength="20">
      <button id="btn-start-game" class="btn-primary">Start</button>
    </div>
  </div>

  <!-- Weapon choice screen (after player name) -->
  <div id="weapon-choice-screen" style="display:none;">
    <div class="weapon-choice-container">
      <h1>Choose your weapon</h1>
      <p>Select the weapon you will hunt with</p>
      
      <div class="weapons-grid">
        <div class="weapon-card" data-weapon="spear">
          <div class="weapon-icon">üî±</div>
          <h3>Spear</h3>
          <p class="weapon-desc">Classic and effective</p>
        </div>
        
        <div class="weapon-card" data-weapon="trident">
          <div class="weapon-icon">üî±</div>
          <h3>Trident</h3>
          <p class="weapon-desc">Triple power</p>
        </div>
      </div>
      
      <button id="btn-validate-weapon" class="btn-primary" disabled>Validate and Dive</button>
    </div>
  </div>

  <!-- Chronom√®tre en jeu (HTML overlay pour PC) -->
  <div id="timer-display" style="display:none;">1:00</div>
  <!-- Bouton pour entrer en mode AR -->
  <div id="ar-overlay" style="display:none;">
    <button id="ar-button">Enter AR ü•Ω</button>
  </div>

  <!-- End game HTML overlay (shown when time ends or all fishes are caught) -->
  <div id="end-game-screen">
    <div class="end-game-container">
      <div class="end-game-header">
        <h1>Game Over</h1>
        <h2 id="end-subtitle">Summary</h2>
      </div>

      <div class="score-table-wrapper">
        <table id="score-table">
          <thead><tr><th>Fish</th><th>Quantity</th><th>Points</th></tr></thead>
          <tbody id="score-table-body"></tbody>
        </table>
      </div>

      <div class="end-game-buttons">
        <button class="btn-end btn-restart" id="btn-restart">Play Again</button>
        <button class="btn-end btn-leaderboard" id="btn-leaderboard">Leaderboard</button>
        <button class="btn-end btn-quit" id="btn-quit">Quit</button>
      </div>
    </div>
  </div>

  <!-- Leaderboard Screen -->
  <div id="leaderboard-screen">
    <div class="leaderboard-container">
      <div class="leaderboard-header">
        <h1>üèÜ Leaderboard üèÜ</h1>
        <h2>Top 8 Players</h2>
      </div>

      <div class="score-table-wrapper">
        <table id="leaderboard-table">
          <thead><tr><th>#</th><th>Player</th><th>Score</th></tr></thead>
          <tbody id="leaderboard-table-body"></tbody>
        </table>
      </div>

      <div class="end-game-buttons">
        <button class="btn-end btn-restart" id="btn-leaderboard-restart">Play Again</button>
        <button class="btn-end btn-quit" id="btn-leaderboard-quit">Main Menu</button>
      </div>
    </div>
  </div>

  <!-- Sc√®ne A-Frame avec configuration WebXR native pour AR -->
  <a-scene webxr="referenceSpaceType: local-floor; overlayElement: #ar-overlay; requiredFeatures: local-floor, hit-test, plane-detection, mesh-detection; optionalFeatures: depth-sensing, anchors;" room-detection
    grab-manager
    physics="gravity: 0"
    fog="type: exponential; color: #0066aa; density: 0.04"
    renderer="colorManagement: true; alpha: true; antialias: true; sortTransparentObjects: true">

    <a-assets>
      <a-asset-item id="spear-model" src="/SAE4.02/assets/models/stylized_low-poly_spear.glb"></a-asset-item>
      <!-- Mod√®les d'armes additionnels -->
      <a-asset-item id="trident-model" src="/SAE4.02/assets/models/trident-2.glb"></a-asset-item>
      <a-asset-item id="harpoon-model" src="/SAE4.02/assets/models/stylized_low-poly_spear.glb"></a-asset-item>
      
      <a-asset-item id="goldfish" src="/SAE4.02/assets/models/Goldfish.glb"></a-asset-item>
      <a-asset-item id="piranha" src="/SAE4.02/assets/models/Piranha.glb"></a-asset-item>
      <a-asset-item id="thon" src="/SAE4.02/assets/models/thon.glb"></a-asset-item>
      <a-asset-item id="thon_bleu" src="/SAE4.02/assets/models/thon_bleu.glb"></a-asset-item>
      <a-asset-item id="starfish" src="/SAE4.02/assets/models/Starfish.glb"></a-asset-item>
      
      <!-- Musique de fond -->
      <audio id="bg-music" src="/SAE4.02/assets/blackbox-black-box-drum-drum-drum-14105.mp3" preload="auto"></audio>
    </a-assets>

    <!-- Musique de fond (d√©marre quand le jeu commence) -->
    <a-entity id="background-music" 
              sound="src: #bg-music; autoplay: false; loop: true; volume: 0.4" 
              position="0 0 0"></a-entity>

    <!-- Ancre monde : tous les objets 3D sont enfants de cette entit√© pour rester fixes dans l'espace r√©el -->
    <a-entity id="world-anchor" fish-spawner="count: 12">

    <!-- Camera HUD: bonus target, score and 3D timer -->
    <a-entity id="cameraRig">
      <a-camera id="head" look-controls>
        <!-- Effet sous l'eau : sph√®re bleue semi-transparente autour de la cam√©ra -->
        <a-sphere radius="8" color="#0088cc" opacity="0.15" material="transparent: true; side: back; shader: flat"></a-sphere>
        
        <!-- Cursor for mouse (desktop) and gaze interactions -->
        <a-entity cursor="rayOrigin: mouse" raycaster="objects: .clickable" position="0 0 -1"></a-entity>
        <a-entity id="bonus-fish" position="-0.15 0.2 -0.7" scale="0.8 0.8 0.8" visible="false">
          <!-- Fond du panneau (style oc√©anique) -->
          <a-plane color="#001e3c" opacity="0.95" width="0.38" height="0.28" position="0 0 -0.02" material="shader: flat"></a-plane>

          <!-- Bordure cyan (style oc√©anique) -->
          <a-box color="#00d4ff" width="0.38" height="0.01" depth="0.01" position="0 0.135 0"></a-box>
          <a-box color="#00d4ff" width="0.38" height="0.01" depth="0.01" position="0 -0.135 0"></a-box>
          <a-box color="#00d4ff" width="0.01" height="0.26" depth="0.01" position="-0.185 0 0"></a-box>
          <a-box color="#00d4ff" width="0.01" height="0.26" depth="0.01" position="0.185 0 0"></a-box>

          <a-entity position="0 0 0.03">
            <a-entity id="fish-3d" gltf-model="#goldfish" position="0 0.01 0" rotation="0 90 0" scale="0.002 0.002 0.002" fish-rotator="interval: 8000"></a-entity>
            <a-text value="TARGET" align="center" color="#00ffcc" width="0.7" position="0 -0.09 0.01" font="roboto"></a-text>
          </a-entity>
        </a-entity>

        <a-text id="score-display" value="Fish: 0" position="-0.15 0.0 -0.7" align="center" color="#00ffcc" width="0.6" font="roboto" shader="msdf" visible="false"></a-text>

        <a-entity id="timer-3d" position="0.25 0.25 -0.7" scale="0.6 0.6 0.6" visible="false">
          <a-plane color="#001e3c" opacity="0.95" width="0.25" height="0.12" position="0 0 -0.01"></a-plane>
          <a-text id="timer-text" value="1:00" align="center" color="#00ffcc" width="0.8" position="0 0 0"></a-text>
        </a-entity>

        <!-- Start button for VR (3D) - hidden until room scan completes -->
        <a-entity id="start-button-3d" class="clickable" position="0 -0.1 -0.7" visible="false">
          <a-box class="clickable" color="#3498db" width="0.45" height="0.12" depth="0.03">
            <a-text value="‚ñ∂ PLAY" align="center" anchor="center" baseline="center" color="#ffffff" width="1.2" position="0 0 0.02"></a-text>
          </a-box>
        </a-entity>

        <!-- √âcran de fin de jeu en 3D (style oc√©anique) -->
        <a-entity id="end-screen-3d" position="0 0 -1.5" visible="false">
          <!-- Fond du panneau -->
          <a-plane color="#001e3c" opacity="0.95" width="1.2" height="1.6" position="0 0 -0.02" material="shader: flat"></a-plane>
          <!-- Bordure cyan -->
          <a-box color="#00d4ff" width="1.2" height="0.02" depth="0.01" position="0 0.8 0"></a-box>
          <a-box color="#00d4ff" width="1.2" height="0.02" depth="0.01" position="0 -0.8 0"></a-box>
          <a-box color="#00d4ff" width="0.02" height="1.6" depth="0.01" position="-0.6 0 0"></a-box>
          <a-box color="#00d4ff" width="0.02" height="1.6" depth="0.01" position="0.6 0 0"></a-box>

          <!-- Title -->
          <a-text value="üé£ GAME OVER üé£" align="center" color="#00ffcc" width="1.8" position="0 0.65 0"></a-text>
          <a-text value="Fishes caught" align="center" color="#00d4ff" width="1.5" position="0 0.52 0"></a-text>

          <!-- Le tableau sera g√©n√©r√© dynamiquement ici par populateScoreTable3D() -->
          <a-entity id="dynamic-score-table-3d" position="0 0 0.01"></a-entity>

          <!-- Boutons interactifs avec animations hover (3 boutons align√©s) -->
          <a-box id="btn-restart-3d" class="clickable" color="#FFD700" width="0.35" height="0.12" depth="0.03" position="-0.4 -0.65 0.02"
                 animation__hover="property: scale; from: 1 1 1; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 200"
                 animation__leave="property: scale; from: 1.1 1.1 1.1; to: 1 1 1; startEvents: mouseleave; dur: 200">
            <a-text value="üîÑ PLAY AGAIN" align="center" color="#000000" width="1.4" position="0 0 0.02"></a-text>
          </a-box>

          <a-box id="btn-leaderboard-3d" class="clickable" color="#4169E1" width="0.35" height="0.12" depth="0.03" position="0 -0.65 0.02"
                 animation__hover="property: scale; from: 1 1 1; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 200"
                 animation__leave="property: scale; from: 1.1 1.1 1.1; to: 1 1 1; startEvents: mouseleave; dur: 200">
            <a-text value="üèÜ LEADERBOARD" align="center" color="#ffffff" width="1.2" position="0 0 0.02"></a-text>
          </a-box>

          <a-box id="btn-quit-3d" class="clickable" color="#e74c3c" width="0.35" height="0.12" depth="0.03" position="0.4 -0.65 0.02"
                 animation__hover="property: scale; from: 1 1 1; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 200"
                 animation__leave="property: scale; from: 1.1 1.1 1.1; to: 1 1 1; startEvents: mouseleave; dur: 200">
            <a-text value="‚ùå QUIT" align="center" color="#ffffff" width="1.4" position="0 0 0.02"></a-text>
          </a-box>
        </a-entity>

      </a-camera>
    </a-entity>

    <!-- Ground for physics collisions -->
    <a-entity id="ground" geometry="primitive: plane; width: 20; height: 20" rotation="-90 0 0" position="0 0 0" visible="false" static-body></a-entity>
      <!-- Les poissons seront g√©n√©r√©s automatiquement par fish-spawner apr√®s le scan de la pi√®ce -->

      <!-- Lumi√®res -->
      <a-light type="ambient" color="#aaccff" intensity="0.6"></a-light>
      <a-light type="directional" color="#cce6ff" intensity="0.7" position="1 2 1"></a-light>
      <!-- Lumi√®re bleut√©e sous l'eau -->
      <a-light type="point" color="#0088ff" intensity="0.5" position="0 0.5 -2"></a-light>

      <!-- Spear model - grabbable weapon -->
      <a-entity id="spear" weapon position="0 1.45 -0.8" rotation="0 90 0" 
            class="weapon"
            geometry="primitive: box; width: 0.4; height: 0.4; depth: 1.5"
            material="opacity: 0; transparent: true; shader: flat; depthWrite: false"
            visible="true">
        <!-- Conteneur pour le mod√®le 3D -->
        <a-entity id="weapon-3d-model"></a-entity>
      </a-entity>

      <!-- Les poissons seront g√©n√©r√©s automatiquement par fish-spawner apr√®s le scan de la pi√®ce -->

      <!-- Bubble spawner: spawn intermittently under water inside the detected room -->
      <a-entity id="bubble-spawner" bubble-spawner></a-entity>

      <!-- Coral placer: place coral models on yellow visuals and on the floor after scan -->


    </a-entity>

    <!-- VR Hands with laser controls and raycasters to interact with 3D UI -->
    <a-entity id="leftHand" hand-controls="hand: left; handModelStyle: lowPoly; color: #15ACCF" laser-controls="hand: left" raycaster="objects: .clickable"></a-entity>
    <a-entity id="rightHand" hand-controls="hand: right; handModelStyle: lowPoly; color: #15ACCF" laser-controls="hand: right" raycaster="objects: .clickable"></a-entity>

    <!-- EFFET D'EAU QUI MONTE avec shader Three.js (positionn√©e dans le monde, pas au niveau de la cam√©ra) -->
    <a-entity id="water-surface" position="0 0 -2" water-adapter>

      <!-- Surface d'eau avec effet de vagues fluides (couche principale bleu profond) -->
      <a-entity id="water-fluid"
        visible="false"
        water-shader="color: #004b7f; opacity: 0.75; speed: 1.5; waveHeight: 0.08; waveFrequency: 1.5">
      </a-entity>

      <!-- Deuxi√®me couche d'eau plus claire pour la profondeur -->
      <a-entity position="0 -0.05 0" visible="false"
        water-shader="color: #006fb3; opacity: 0.35; speed: 0.8; waveHeight: 0.05; waveFrequency: 2.0">
      </a-entity>
    </a-entity>

    <!-- (moved bubble-spawner into world-anchor) -->

  </a-scene>

  <script src="/SAE4.02/src/systems/game-manager.js"></script>
</body>

</html>