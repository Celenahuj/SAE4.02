<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cube XR - SAE 4.02</title>
  <link rel="stylesheet" href="src/styles/style.css">

  <!-- Importation d'A-Frame et des extensions nÃ©cessaires -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@4.0.1/dist/aframe-physics-system.min.js"></script>


  <!-- Importation des composants -->
  <script src="src/utils/compatibility-shims.js"></script>
  <script src="src/components/water-effect.js"></script>
  <script src="src/components/water-adapter.js"></script>
  <script src="src/components/grab-manager.js"></script>
  <script src="src/components/bubble-spawner.js"></script>
  <script src="src/components/coral-placer.js"></script>
  <script src="src/components/fish-spawner.js"></script>
  <script src="src/components/room-detection.js"></script>
</head>

<body>
  <!-- Bouton pour entrer en mode AR -->
  <div id="ar-overlay">
    <button id="ar-button">Entrer en AR ðŸ¥½</button>
  </div>

  <!-- ScÃ¨ne A-Frame avec configuration WebXR native pour AR -->
  <a-scene webxr="referenceSpaceType: local-floor; overlayElement: #ar-overlay; requiredFeatures: local-floor, hit-test, plane-detection, mesh-detection; optionalFeatures: depth-sensing, anchors;" room-detection
    grab-manager
    physics="gravity: 0"
    fog="type: exponential; color: #001a33; density: 0.02"
    renderer="colorManagement: true; alpha: true; antialias: true; sortTransparentObjects: true">

    <!-- Assets must be inside a-scene -->
    <a-assets>
      <a-asset-item id="spear-model" src="assets/models/stylized_low-poly_spear.glb"></a-asset-item>
      <a-asset-item id="low_poly_fish" src="assets/models/low_poly_fish.glb"></a-asset-item>
      <!-- Additional fish models for variety -->
      <a-asset-item id="fish_fish" src="assets/models/Fish.glb"></a-asset-item>
      <a-asset-item id="fish_1" src="assets/models/Fish_1.glb"></a-asset-item>
      <a-asset-item id="fish_2" src="assets/models/Fish_2.glb"></a-asset-item>
      <a-asset-item id="fish_bubbles" src="assets/models/Fish_Bubbles.glb"></a-asset-item>
      <!-- Goldfish asset so one target can be adjusted individually -->
      <a-asset-item id="goldfish" src="assets/models/Goldfish.glb"></a-asset-item>
      <a-asset-item id="piranha" src="assets/models/Piranha.glb"></a-asset-item>
      <a-asset-item id="starfish" src="assets/models/Starfish.glb"></a-asset-item>
    </a-assets>

    <!-- Ancre monde : tous les objets 3D sont enfants de cette entitÃ© pour rester fixes dans l'espace rÃ©el -->
    <a-entity id="world-anchor" fish-spawner="count: 12">

    <!-- Ground for physics collisions -->
    <a-entity id="ground" geometry="primitive: plane; width: 20; height: 20" rotation="-90 0 0" position="0 0 0" visible="false" static-body></a-entity>
      <!-- Les poissons seront gÃ©nÃ©rÃ©s automatiquement par fish-spawner aprÃ¨s le scan de la piÃ¨ce -->

      <!-- LumiÃ¨res -->
      <a-light type="ambient" color="#ffffff" intensity="0.6"></a-light>
      <a-light type="directional" color="#ffffff" intensity="0.8" position="1 2 1"></a-light>
      <!-- LumiÃ¨re bleutÃ©e sous l'eau -->
      <a-light type="point" color="#0088ff" intensity="0.5" position="0 0.5 -2"></a-light>

      <!-- Spear model (replace the blue cube) - grabbable -->
      <a-entity id="spear" weapon position="0 1.45 -0.6" rotation="0 90 0" 
        class="weapon"
        geometry="primitive: box; width: 0.05; height: 0.05; depth: 0.6" 
        material="color: #ff0000; opacity: 0; transparent: true"
        gltf-model="#spear-model"
        scale="0.5 0.5 0.5"
        dynamic-body="mass:1">
      </a-entity>

      <!-- Les poissons seront gÃ©nÃ©rÃ©s automatiquement par fish-spawner aprÃ¨s le scan de la piÃ¨ce -->

      <!-- Bubble spawner: spawn intermittently under water inside the detected room -->
      <a-entity id="bubble-spawner" bubble-spawner></a-entity>

      <!-- Coral placer: place coral models on yellow visuals and on the floor after scan -->
      <a-entity id="coral-placer" coral-placer></a-entity>

    </a-entity>

    <!-- VR Hands -->
    <a-entity id="leftHand" hand-controls="hand: left; handModelStyle: lowPoly; color: #15ACCF"></a-entity>
    <a-entity id="rightHand" hand-controls="hand: right; handModelStyle: lowPoly; color: #15ACCF"></a-entity>

    <!-- EFFET D'EAU QUI MONTE avec shader Three.js (positionnÃ©e dans le monde, pas au niveau de la camÃ©ra) -->
    <a-entity id="water-surface" position="0 0 -2" water-adapter
      animation="property: position; from: 0 0 -2; to: 0 2.5 -2; dur: 10000; easing: easeInOutQuad">

      <!-- Surface d'eau avec effet de vagues fluides (couche principale bleu profond) -->
      <a-entity id="water-fluid"
        visible="false"
        water-shader="color: #004b7f; opacity: 0.75; speed: 1.5; waveHeight: 0.08; waveFrequency: 1.5">
      </a-entity>

      <!-- DeuxiÃ¨me couche d'eau plus claire pour la profondeur -->
      <a-entity position="0 -0.05 0" visible="false"
        water-shader="color: #006fb3; opacity: 0.35; speed: 0.8; waveHeight: 0.05; waveFrequency: 2.0">
      </a-entity>
    </a-entity>

    <!-- (moved bubble-spawner into world-anchor) -->

  </a-scene>

  <script src="src/systems/game-manager.js"></script>
</body>

</html>